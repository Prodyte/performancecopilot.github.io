<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/TR/xhtml1/transitional" xmlns:fo="http://www.w3.org/1999/XSL/Format"><head xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title xmlns:d="http://docbook.org/ns/docbook">3.8.8.3.  pmRecordSetup Function</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta xmlns:d="http://docbook.org/ns/docbook" name="generator" content="publican v4.3.2" /><meta xmlns:d="http://docbook.org/ns/docbook" name="package" content="PCP-pcp-programmers-guide-3-en-US-4.0-4" /><link rel="home" href="index.html" title="Performance Co-Pilot™ Programmer's Guide" /><link rel="up" href="LE40692-PARENT.html" title="3.8.8. PMAPI Record-Mode Services" /><link rel="prev" href="LE35969-PARENT.html" title="3.8.8.2.  pmRecordControl Function" /><link rel="next" href="LE85604-PARENT.html" title="3.8.9. PMAPI Archive-Specific Services" />
<meta xmlns="" charset="utf-8" />
<meta xmlns="" content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
<meta xmlns="" content="initial-scale=1" name="viewport" />
<title xmlns="">Performance Co-Pilot</title>
<link xmlns="" href="/assets/css/screen.css" media="all" rel="stylesheet" type="text/css" />
<link xmlns="" href="/assets/css/master.css" media="all" rel="stylesheet" type="text/css" />
<link xmlns="" href="/images/pcp.ico" rel="shortcut icon" type="image/ico" />
</head><body>
    <header xmlns="" class="global-header">
      <div class="row">
        <h1 class="global-logo colspan12-6 colspan8-4 colspan6-3 colspan2-1 as-grid">
          <a href="/index.html">Performance Co-Pilot</a>
        </h1>
        <nav class="global-header__navigation colspan12-6 colspan8-6 colspan6-4 colspan2-1 as-grid">
          <ul>
            <li>
              <a href="/features.html">Features</a>
            </li>
            <li>
              <a href="/documentation.html">Documentation</a>
            </li>
            <li>
              <a href="/download.html">Download</a>
            </li>
            <li>
              <a href="/community.html">Get Involved</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
<div class="site-content"><div class="how-to is-typeset"><div class="row-parent"><div class="row"><p xmlns="http://www.w3.org/1999/xhtml" id="title"><a class="left" href="https://pcp.io"><img alt="Product Site" src="Common_Content/images//image_left.png" /></a><a class="right" href="https://pcp.io/documentation.html"><img alt="Documentation Site" src="Common_Content/images//image_right.png" /></a></p><ul xmlns="http://www.w3.org/1999/xhtml" class="docnav top"><li class="previous"><a accesskey="p" href="LE35969-PARENT.html"><strong>Prev</strong></a></li><li class="home">pcp-programmers-guide</li><li class="next"><a accesskey="n" href="LE85604-PARENT.html"><strong>Next</strong></a></li></ul><div xmlns="http://www.w3.org/1999/xhtml" class="section"><div class="titlepage"><div><div keep-together.within-column="always"><h4 class="title"><a id="id5206798">
      ⁠</a>3.8.8.3.  <code class="command">pmRecordSetup</code> Function</h4></div></div></div><pre class="literallayout">FILE *pmRecordSetup(const char *<em class="replaceable">folio</em>, const char *<em class="replaceable">creator</em>, int <em class="replaceable">replay</em>)
<code class="command">Python:</code>
int <em class="replaceable">status</em> = pmRecordSetup("folio string", "creator string", int replay)</pre><div class="para">
						<a id="IG31340177398" class="indexterm"></a>The <code class="command">pmRecordSetup</code> function along with the <code class="command">pmRecordAddHost</code> and <code class="command">pmRecordControl</code> functions may be used to create a PCP archive on the fly to support record-mode services for PMAPI client applications.
					</div><div class="para">
						Each record mode session involves one or more PCP archive logs; each is created using a dedicated <code class="command">pmlogger</code> process, with an overall Archive Folio format as understood by the <code class="command">pmafm</code> command, to name and collect all of the archive logs associated with a single recording session.
					</div><div class="para">
						The <code class="filename">pmRecordHost</code> structure is used to maintain state information between the creator of the recording session and the associated <code class="command">pmlogger</code> process(es). The structure, shown in <a class="xref" href="id5206798.html#Z976560662sdc">Example 3.16, “ <code class="filename">pmRecordHost</code> Structure”</a>, is defined as:
					</div><div class="example"><a id="Z976560662sdc">
      ⁠</a><p class="title"><strong>Example 3.16.  <code class="filename">pmRecordHost</code> Structure</strong></p><div class="example-contents"><pre class="programlisting">typedef struct {
    FILE   *f_config;    /* caller writes pmlogger configuration here */
    int    fd_ipc;       /* IPC channel to pmlogger */
    char   *logfile;     /* full pathname for pmlogger error logfile */
    pid_t  pid;          /* process id for pmlogger */
    int    status;       /* exit status, -1 if unknown */
} pmRecordHost;</pre></div></div><div class="para">
						In <a class="xref" href="id5206798.html#id5206969">Procedure 3.1, “Creating a Recording Session”</a>, the functions are used in combination to create a recording session.
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="procedure"><a id="id5206969">
      ⁠</a><p class="title"><strong>Procedure 3.1. Creating a Recording Session</strong></p><ol class="1"><li class="step"><div class="para">
								Call <code class="command">pmRecordSetup</code> to establish a new recording session. A new Archive Folio is created using the name <em class="replaceable">folio</em>. If the <em class="replaceable">folio</em> file or directory already exists, or if it cannot be created, this is an error. The application that is creating the session is identified by creator (most often this would be the same as the global PMAPI application name, as returned <code class="literal">pmGetProgname()</code>). If the application knows how to create its own configuration file to replay the recorded session, replay should be nonzero. The <code class="command">pmRecordSetup</code> function returns a stdio stream onto which the application writes the text of any required replay configuration file.
							</div></li><li class="step"><div class="para">
								For each host that is to be included in the recording session, call <code class="command">pmRecordAddHost</code>. A new <code class="filename">pmRecordHost</code> structure is returned via <em class="replaceable">rhp</em>. It is assumed that PMCD is running on the host as this is how <code class="command">pmlogger</code> retrieves the required performance metrics. See <a class="xref" href="LE40692-PARENT.html#LE13213-PARENT">Section 3.8.8.1, “ <code class="command">pmRecordAddHost</code> Function”</a> for more information.
							</div></li><li class="step"><div class="para">
								Optionally, add arguments to the command line that is used to launch <code class="command">pmlogger</code> by calling <code class="command">pmRecordControl</code> with a request of <code class="literal">PM_REC_SETARG</code>. The argument is passed via options and one call to <code class="command">pmRecordControl</code> is required for each distinct argument. See <a class="xref" href="LE35969-PARENT.html">Section 3.8.8.2, “ <code class="command">pmRecordControl</code> Function”</a> for more information.
							</div></li><li class="step"><div class="para">
								To commence the recording session, call <code class="command">pmRecordControl</code> with a request of <code class="literal">PM_REC_ON</code>, and <em class="replaceable">rhp</em> must be NULL.
							</div></li><li class="step"><div class="para">
								To terminate a <code class="command">pmlogger</code> instance identified by <em class="replaceable">rhp</em>, call <code class="command">pmRecordControl</code> with a request of <code class="literal">PM_REC_OFF</code>.
							</div></li><li class="step"><div class="para">
								To display the current status of the <code class="command">pmlogger</code> instance identified by <em class="replaceable">rhp</em>, call <code class="command">pmRecordControl</code> with a request of <code class="literal">PM_REC_STATUS</code>.
							</div></li><li class="step"><div class="para">
								To detach a <code class="command">pmlogger</code> instance identified by <em class="replaceable">rhp</em>, allow it to continue independent of the application that launched the recording session, call <code class="command">pmRecordControl</code> with a request of <code class="literal">PM_REC_DETACH</code>.
							</div></li></ol></div><div class="para">
						The calling application should not close any of the returned stdio streams; <code class="command">pmRecordControl</code> performs this task when recording is commenced.
					</div><div class="para">
						Once <code class="command">pmlogger</code> has been started for a recording session, <code class="command">pmlogger</code> assumes responsibility for any dialogue with the user in the event that the application that launched the recording session should exit, particularly without terminating the recording session.
					</div><div class="para">
						By default, information and dialogues from <code class="command">pmlogger</code> is displayed using <code class="command">pmconfirm</code>. This default is based on the assumption that most applications launching a recording session are GUI-based. In the event that <code class="command">pmconfirm</code> fails to display the information (for example, because the <code class="literal">DISPLAY</code> environment variable is not set), <code class="command">pmlogger</code> writes on its own stderr stream (not the stderr stream of the launching process). The output is assigned to the <code class="filename"><em class="replaceable">xxxxxx</em>.host.log</code> file. For convenience, the full pathname to this file is provided via the <code class="literal">logfile</code> field in the <code class="filename">pmRecordHost</code> structure.
					</div><div class="para">
						If the <em class="replaceable">options</em> argument to <code class="command">pmRecordControl</code> is not NULL, this string may be used to pass additional arguments to <code class="command">pmconfirm</code> in those cases where a dialogue is to be displayed. One use of this capability is to provide a -geometry string to control the placement of the dialogue.
					</div><div class="para">
						Premature termination of a launched <code class="command">pmlogger</code> process may be determined using the <code class="filename">pmRecordHost</code> structure, by calling <code class="command">select</code> on the <code class="literal">fd_ipc</code> field or polling the <code class="literal">status</code> field that will contain the termination status from <code class="command">waitpid</code> if known, or -1.
					</div><div class="para">
						These functions create a number of files in the same directory as the <em class="replaceable">folio</em> file named in the call to <code class="command">pmRecordSetup</code>. In all cases, the <em class="replaceable">xxxxxx</em> component is the result of calling <code class="command">mkstemp</code>.
					</div><div xmlns:d="http://docbook.org/ns/docbook" class="itemizedlist"><ul><li class="listitem"><div class="para">
								If replay is nonzero, <em class="replaceable">xxxxxx</em> is the creator's replay configuration file, else an empty control file, used to guarantee uniqueness.
							</div></li><li class="listitem"><div class="para">
								The <em class="replaceable">folio</em> file is the PCP Archive Folio, suitable for use with the <code class="command">pmafm</code> command.
							</div></li><li class="listitem"><div class="para">
								The <code class="filename"><em class="replaceable">xxxxxx</em>.host.confi</code>g file is the <code class="command">pmlogger</code> configuration for each host. If the same host is used in different calls to <code class="command">pmRecordAddHost</code> within the same recording session, one of the letters 'a' through 'z' is appended to the <em class="replaceable">xxxxxx</em> part of all associated file names to ensure uniqueness.
							</div></li><li class="listitem"><div class="para">
								<code class="filename"> <em class="replaceable">xxxxxx</em>.host.log</code> is stdout and stderr for the <code class="command">pmlogger</code> instance for each host.
							</div></li><li class="listitem"><div class="para">
								The <code class="filename"><em class="replaceable">xxxxxx</em>.host.{0,meta,index}</code> files comprise a single PCP archive for each host.
							</div></li></ul></div><div class="para">
						<code class="command">pmRecordSetup</code> may return NULL in the event of an error. Check <code class="literal">errno</code> for the real cause. The value <code class="literal">EINVAL</code> typically means that the order of calls to these functions is not correct; that is, there is an obvious state associated with the current recording session that is maintained across calls to the functions.
					</div><div class="para">
						For example, calling <code class="command">pmRecordControl</code> before calling <code class="command">pmRecordAddHost</code> at least once, or calling <code class="command">pmRecordAddHost</code> before calling <code class="command">pmRecordSetup</code> would produce an <code class="literal">EINVAL</code> error.
					</div></div><ul xmlns="http://www.w3.org/1999/xhtml" class="docnav"><li class="previous"><a accesskey="p" href="LE35969-PARENT.html"><strong>Prev</strong>3.8.8.2.  pmRecordControl Function</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="LE85604-PARENT.html"><strong>Next</strong>3.8.9. PMAPI Archive-Specific Services</a></li></ul></div></div></div></div>
<footer xmlns="" class="global-footer is-typeset">
  <div class="row-parent">
    <div class="row">
      <section class="row__colspaced"><div class="colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter">
          <div class="col__module">
            <h4>Main Menu</h4>
            <ul>
              <li>
                <a href="/features.html">Features</a>
              </li>
              <li>
                <a href="/documentation.html">Documentation</a>
              </li>
              <li>
                <a class="download" href="/download.html">Download</a>
              </li>
            </ul>
          </div>
        </div><div class="colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter">
          <div class="col__module">
            <h4>Developers</h4>
            <ul>
              <li>
                <a href="http://git.pcp.io/bugzilla">Report a bug</a>
              </li>
              <li>
                <a href="/community.html">Contributing</a>
              </li>
              <li>
                <a href="/team.html">Team</a>
              </li>
            </ul>
          </div>
        </div><div class="colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter">
          <div class="col__module">
            <h4>About</h4>
            <ul>
              <li>
                <a href="/news.html">News</a>
              </li>
              <li>
                <a href="/testimonials.html">Testimonials</a>
              </li>
              <li>
                <a href="/faq.html">FAQ</a>
              </li>
              <li>
                <a href="/website.html">Website</a>
              </li>
            </ul>
          </div>
        </div><div class="colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter">
          <div class="col__module">
            <h4>Get Social</h4>
            <ul>
              <li>
                <a class="twitter" href="https://twitter.com/performancepcp" rel="external">Twitter</a>
              </li>
              <li>
                <a class="github" href="https://github.com/performancecopilot" rel="external">Github</a>
              </li>
            </ul>
          </div>
        </div></section>
    </div>
    <div class="row">
      <div class="colspan2-2">
        <p class="legal">
          Copyright 2000-2004 Silicon Graphics Inc, 2007-2010 Aconex, 2012-2015 Red Hat
        </p>
      </div>
    </div>
  </div>
</footer>
</body></html>