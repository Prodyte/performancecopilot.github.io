---
- name: Git Repo and Gogs Setup
  hosts: centos7vm
  tasks:
    - name: make git directory
      file:
        path: /git/
        state: directory

    - name: add git user
      user:
        name: "Gogs"

    - name: disable git user login
      shell: 'passwd -l git'

    - name: Set goroot for git user
      become: true
      become_user: git
      become_method: su
      lineinfile:
        path: /home/git/.bashrc
        regexp: "^export GOROOT="
        line: "export GOROOT=$HOME/local/go"

    - name: Set gopath for git user
      become: true
      become_user: git
      become_method: su
      lineinfile:
        path: /home/git/.bashrc
        regexp: "^export GOPATH="
        line: "export GOPATH=$HOME/go"

    - name: Set gopath for git user
      become: true
      become_user: git
      become_method: su
      lineinfile:
        path: /home/git/.bashrc
        regexp: "^export PATH"
        line: "export PATH=$PATH:$GOROOT/bin:$GOPATH/bin"

    - name: make git directory
      become: true
      become_user: git
      become_method: su
      file:
        path: /home/git/local
        state: directory

    - name: Get gogs
      become: true
      become_user: git
      become_method: su
      shell: 'go get -u github.com/gogs/gogs'

    - name: remove old gogs bin
      file:
        path: /home/git/go/src/github.com/gogs/gogs/gogs
        state: absent

    - name: create gogs custom directory
      file: path=/home/git/go/src/github.com/gogs/gogs/custom/conf/
      state: directory

    - name: place custom gogs config file
      template:
        src: roles/templates/gogs.app.ini.j2
        dest: /home/git/go/src/github.com/gogs/gogs/custom/conf/app.ini
        force: yes

    - name: Build gogs
      become: true
      become_user: git
      become_method: su
      shell: 'go build'
      args:
        chdir: /home/git/go/src/github.com/gogs/gogs

    - name: start/enable mariadb
      service:
        name: mariadb
        enabled: yes
        state: restarted

    - name: place gogs service file
      copy:
        src: roles/templates/gogs.service
        dest: /usr/lib/systemd/system/gogs.service
        force: yes

    - name: correct selinux permissions
      sefcontext:
        target: '/git(/.*)?'
        setype: git_content_t
        state: present

    - name: service daemon-reload
      shell: "systemctl daemon-reload"

    - name: start gogs service
      service:
        name: gogs
        state: started
        enabled: yes
